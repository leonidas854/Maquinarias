{% extends 'index.html' %}
{% load static %}

{% block title %}Reportes de Optimización{% endblock %}

{% block extra_css %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .reports-page { padding: 2rem; }
        .reports-layout { display: flex; gap: 2rem; }
        .reports-sidebar { flex: 0 0 250px; }
        .reports-content { flex-grow: 1; }
        .sidebar-menu { list-style: none; padding: 0; }
        .sidebar-menu li a { display: block; padding: 10px 15px; text-decoration: none; color: #333; border-radius: 5px; }
        .sidebar-menu li a.active, .sidebar-menu li a:hover { background-color: #0d6efd; color: white; }
        .filters { display: none; background-color: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; }
        #report-data-view, #report-charts { min-height: 200px; }
    </style>
{% endblock %}

{% block content %}
<div class="page-container reports-page">
    <h2>Reportes de Optimización</h2>
    <div class="reports-layout">
        <aside class="reports-sidebar">
            <h3>Seleccionar Reporte</h3>
            <ul class="sidebar-menu">
                <li><a href="#" data-report="qlearning">Reporte IA (Q-Learning)</a></li>
                <li><a href="#" data-report="entrenamiento">Reporte de Entrenamiento</a></li>
                <!-- Otros reportes -->
            </ul>
        </aside>

        <section class="reports-content">
            <h3 id="report-title">Seleccione un reporte del menú</h3>

            <!-- Filtros para el reporte de Q-Learning -->
            <div id="qlearning-filters" class="filters row g-3 align-items-center">
                <div class="col-auto">
                    <label for="linea-filter" class="col-form-label">Línea:</label>
                </div>
                <div class="col-auto">
                    <select id="linea-filter" class="form-select">
                        {% for linea in lineas %} {# Necesitarás pasar las líneas desde la vista #}
                            <option value="{{ linea.Nombre }}">{{ linea.Nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-auto">
                    <label for="fecha-inicio-filter" class="col-form-label">Desde:</label>
                </div>
                <div class="col-auto">
                    <input type="date" id="fecha-inicio-filter" class="form-control">
                </div>
                <div class="col-auto">
                    <label for="fecha-fin-filter" class="col-form-label">Hasta:</label>
                </div>
                <div class="col-auto">
                    <input type="date" id="fecha-fin-filter" class="form-control">
                </div>
                <div class="col-auto">
                    <button id="qlearning-apply-filters" class="btn btn-primary">Aplicar</button>
                </div>
            </div>

            <!-- Contenedor para las gráficas -->
            <div id="report-charts" class="mb-4"></div>

            <!-- Contenedor para la tabla de datos -->
            <div id="report-data-view" class="table-responsive">
                <p class="placeholder-text">Seleccione y aplique filtros para ver los datos.</p>
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const qlearningReportLink = document.querySelector('a[data-report="qlearning"]');
    const qlearningFilters = document.getElementById('qlearning-filters');
    const applyFiltersBtn = document.getElementById('qlearning-apply-filters');
    const reportTitle = document.getElementById('report-title');
    const dataView = document.getElementById('report-data-view');
    const chartsView = document.getElementById('report-charts');
    const entrenamientoReportLink = document.querySelector('a[data-report="entrenamiento"]');
    
    let charts = {}; // Para guardar las instancias de las gráficas

entrenamientoReportLink.addEventListener('click', async function(e) {
        e.preventDefault();
        document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
        this.classList.add('active');
        
        reportTitle.textContent = "Rendimiento del Modelo durante el Entrenamiento";
        qlearningFilters.style.display = 'none'; 
        chartsView.innerHTML = '<p>Cargando datos de entrenamiento...</p>';
        dataView.innerHTML = ''; 

        try {
            const response = await fetch('api/reporte-entrenamiento/');
            const data = await response.json();

            if (data.error) throw new Error(data.error);
            
            createEntrenamientoCharts(data);

        } catch (error) {
            chartsView.innerHTML = `<p class="text-danger">Error al cargar los datos de entrenamiento: ${error.message}</p>`;
        }
    });


    qlearningReportLink.addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
        this.classList.add('active');
        
        reportTitle.textContent = "Reporte de Decisiones IA";
        qlearningFilters.style.display = 'flex';
        dataView.innerHTML = '<p class="placeholder-text">Seleccione y aplique filtros para ver los datos.</p>';
        chartsView.innerHTML = ''; 
    });

    applyFiltersBtn.addEventListener('click', async function() {
        const linea = document.getElementById('linea-filter').value;
        const fechaInicio = document.getElementById('fecha-inicio-filter').value;
        const fechaFin = document.getElementById('fecha-fin-filter').value;

        if (!linea) {
            alert('Por favor, seleccione una línea.');
            return;
        }

        dataView.innerHTML = '<p>Cargando datos...</p>';
        chartsView.innerHTML = '';

        const apiUrl = new URLSearchParams({
            linea: linea,
            fecha_inicio: fechaInicio,
            fecha_fin: fechaFin
        });
        
        try {
            const response = await fetch(`api/reporte-qlearning/?${apiUrl.toString()}`);
            const data = await response.json();

            if (data.error) throw new Error(data.error);
            
            displayReportData(data);
            createReportCharts(data);

        } catch (error) {
            dataView.innerHTML = `<p class="text-danger">Error al cargar los datos: ${error.message}</p>`;
        }
    });

     function displayReportData(data) {
        if (data.length === 0) {
            dataView.innerHTML = '<p>No se encontraron datos para los filtros seleccionados.</p>';
            return;
        }

        const headers = ['Fecha', 'Recomendación IA', 'Decisión Humana', 'Acción Final', 'Intervención de', 'Temp', 'Presión', 'Uso', 'Recompensa', 'Usuario', 'Comentario'];
        
        let tableHTML = '<table class="table table-striped table-hover"><thead><tr>';
        headers.forEach(h => tableHTML += `<th>${h}</th>`);
        tableHTML += '</tr></thead><tbody>';

        data.forEach(row => {

           let intervencionTexto, decisionHumanaTexto;

            if (row.Invervencion === true) {
            
                intervencionTexto = '<span class="badge bg-warning text-dark">Humano</span>';
         
                decisionHumanaTexto = row.Acc_humana || 'Anulada';
            } else {
          
                intervencionTexto = '<span class="badge bg-info">IA</span>';
               
                decisionHumanaTexto = '---';
            }

            tableHTML += '<tr>';
            tableHTML += `<td>${row.Fecha || ''}</td>`;
            tableHTML += `<td>${row.Acc_IA || ''}</td>`;
            tableHTML += `<td>${decisionHumanaTexto}</td>`;        // <-- CORREGIDO
            tableHTML += `<td>${row.acc_final || ''}</td>`;
            tableHTML += `<td>${intervencionTexto}</td>`;           // <-- CORRECTO
            tableHTML += `<td>${row.Temperatura ? row.Temperatura.toFixed(1) : ''}</td>`;
            tableHTML += `<td>${row.Presion ? row.Presion.toFixed(1) : ''}</td>`;
            tableHTML += `<td>${row.Uso ? row.Uso.toFixed(1) : ''}</td>`;
            tableHTML += `<td>${row.Recompensa || ''}</td>`;
            tableHTML += `<td>${row.Usuario_id__username || 'N/A'}</td>`;
            tableHTML += `<td>${row.Comentario || ''}</td>`;
            tableHTML += '</tr>';
        });

        tableHTML += '</tbody></table>';
        dataView.innerHTML = tableHTML;
    }
    function createReportCharts(data) {
        // Limpiar contenedor de gráficas
        Object.values(charts).forEach(chart => chart.destroy());
        chartsView.innerHTML = `
            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="chart-acciones-ia-aceptadas"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="chart-acciones-humanas"></canvas>
                        </div>
                    </div>
                </div>
            </div>`;

       

        const accionesAceptadasIA = {};
        const accionesAnuladasHumano = {};

        data.forEach(row => {
            if (row.Invervencion === false) {

                const accion = row.acc_final || 'Sin Acción';
                accionesAceptadasIA[accion] = (accionesAceptadasIA[accion] || 0) + 1;
            } else if (row.Invervencion === true) {
    
                const accion = row.Acc_humana || 'Anulada sin especificar';
                accionesAnuladasHumano[accion] = (accionesAnuladasHumano[accion] || 0) + 1;
            }
        });

        const ctx1 = document.getElementById('chart-acciones-ia-aceptadas').getContext('2d');
        charts.accionesAceptadas = new Chart(ctx1, {
            type: 'bar', 
            data: {
                labels: Object.keys(accionesAceptadasIA),
                datasets: [{
                    label: 'Conteo de Acciones',
                    data: Object.values(accionesAceptadasIA),
                    backgroundColor: 'rgba(40, 167, 69, 0.7)',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y', 
                plugins: {
                    title: { display: true, text: 'Acciones Aceptadas de la IA', font: { size: 16 } },
                    legend: { display: false }
                },
                scales: {
                    x: { beginAtZero: true }
                }
            }
        });

        // --- Gráfica 2: Acciones de Intervención Humana ---
        const ctx2 = document.getElementById('chart-acciones-humanas').getContext('2d');
        charts.accionesHumanas = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: Object.keys(accionesAnuladasHumano),
                datasets: [{
                    label: 'Conteo de Acciones',
                    data: Object.values(accionesAnuladasHumano),
                    backgroundColor: 'rgba(220, 53, 69, 0.7)',
                    borderColor: 'rgba(220, 53, 69, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                plugins: {
                    title: { display: true, text: 'Acciones por Intervención Humana', font: { size: 16 } },
                    legend: { display: false }
                },
                scales: {
                    x: { beginAtZero: true }
                }
            }
        });
    }

function createEntrenamientoCharts(data) {
      
        Object.values(charts).forEach(chart => chart.destroy());
        chartsView.innerHTML = `
            <div class="row g-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="chart-reward-progress"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-12 mt-4">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="chart-eplength-progress"></canvas>
                        </div>
                    </div>
                </div>
            </div>`;
        
    
        const ctxReward = document.getElementById('chart-reward-progress').getContext('2d');
        charts.rewardProgress = new Chart(ctxReward, {
            type: 'line',
            data: {
                labels: data.timesteps,
                datasets: [{
                    label: 'Recompensa Media por Episodio',
                    data: data.mean_rewards,
                    borderColor: 'rgba(40, 167, 69, 1)',
                    backgroundColor: 'rgba(40, 167, 69, 0.2)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                plugins: {
                    title: { display: true, text: 'Evolución de la Recompensa Media del Agente', font: { size: 16 } }
                },
                scales: {
                    x: { title: { display: true, text: 'Timesteps de Entrenamiento' } },
                    y: { title: { display: true, text: 'Recompensa Media' } }
                }
            }
        });

       
        const ctxEpLength = document.getElementById('chart-eplength-progress').getContext('2d');
        charts.epLengthProgress = new Chart(ctxEpLength, {
            type: 'line',
            data: {
                labels: data.timesteps,
                datasets: [{
                    label: 'Longitud Media del Episodio',
                    data: data.mean_ep_lengths,
                    borderColor: 'rgba(13, 110, 253, 1)',
                    backgroundColor: 'rgba(13, 110, 253, 0.2)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                plugins: {
                    title: { display: true, text: 'Evolución de la Longitud Media del Episodio', font: { size: 16 } }
                },
                scales: {
                    x: { title: { display: true, text: 'Timesteps de Entrenamiento' } },
                    y: { title: { display: true, text: 'Pasos por Episodio' } }
                }
            }
        });
    }

});



</script>
{% endblock %}